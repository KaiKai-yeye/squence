---------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------上游预处理和测序--------------------------------------------------------------
📚 文库构建的基本流程（Illumina 平台为例）
1️⃣ 样本提取（Sample Extraction）
提取目标 DNA 或 RNA：如果是 RNA，需要先做反转录（Reverse Transcription）转成 cDNA。

2️⃣ 片段化（Fragmentation）
将完整 DNA 切割成较小的片段（一般 200–500 bp）以适合测序读取长度。
方法包括：
      酶切（enzymatic fragmentation）、超声打断（ultrasonication，如 Covaris）、热剪切或机械剪切

3️⃣ 末端修复与加 A 尾（End Repair & A-Tailing）
修复断裂的 DNA 末端，使其变成平端（blunt ends）。给 3' 末端加一个单个 A（腺嘌呤），为后面接头连接做准备。

4️⃣ 接头连接（Adapter Ligation）
将特定的 **双链接头（Adapters）**连接到每个 DNA 片段的两端：
接头内容包括：
    测序接头序列：与 flow cell 上的探针互补，便于固定和扩增。
    Barcode（Index）：样本标识码，用于样本混合测序和区分（如 i5/i7 index）。
    引物结合位点：为测序引物提供结合位置。
    UMI:唯一分子标识，用于识别单个初始DNA或RNA分子
    --------------------------------------------------
    [测序接头序列] — [Barcode（Index）] — [引物结合位点]— [UMI]
    --------------------------------------------------

    | 特性      | Barcode（Index）         | UMI（唯一分子标识）          
    | -------- | -------------------------| ----------------------------------
    | 目的     | 区分不同样本              | 区分同一样本中不同原始分子        
    | 是否随机 | 否，固定预设计            | 是，随机生成（8-12bp）               
    | 是否唯一 | 样本级别唯一              | 分子级别唯一               
    | 放置位置 | 接头的两端（如i5/i7）     | 接头或引物靠近插入序列的一端       
    | 测序方式 | 用专门的 Index Read 测出  | 通常在 Read 1 的起始几bp中测出 

| 属性          | **i7接头**                    | **i5接头**               
| ----------- | ------------------------------ | ---------------------- 
| **位置**      | P7接头侧（Read 1测序方向）     | P5接头侧（Read 2测序方向）      
| **Index编号** | Index 1（或称 i7 Index）      | Index 2（或称 i5 Index）   
| **测序方式**    | 用 **Index Read 1** 读取    | 用 **Index Read 2** 读取  
| **方向/顺序**   | 正向读取                     | 有些平台/试剂盒需要**反向互补读取**   
| **是否必须**    | 是（单Index时必须）          | 可选（双Index时使用）          
| **引入时机**    | 常在接头或引物中固定设计      | 同上                     
| **样本分辨力**   | 单i7 Index能区分样本        | 双Index（i5+i7）提高准确性和防串扰 


5️⃣ 文库纯化（Purification）
去除残余的接头、短片段或酶等。通常使用磁珠纯化（如 AMPure XP beads）按大小选择片段范围。

6️⃣ 可选步骤：文库扩增（Library PCR Amplification）
用 PCR 扩增文库，增加 DNA 量，使其能满足测序需求。需要注意：PCR 循环数不宜过多，否则易引入偏倚。
    文库需要以合适浓度稀释后加载到测序芯片（Flow Cell）上，保证DNA分子均匀、适量地分布，方便桥式扩增形成适量且分散良好的簇（cluster）。
    | 浓度情况     | 可能影响                                                                               
    | ----------- | ----------------------------------------------------------------------------------------------------------------------------------------
    | **浓度过低** | - 上芯片DNA分子数量少，簇数量不足 → 测序通量下降，数据产出低<br>- 测序质量可能下降，信噪比变差                             
    | **浓度过高** | - DNA分子过密，簇间距过近，簇重叠 → 信号混淆，错误率升高<br>- 测序仪难以分辨单个簇，导致数据质量变差<br>- 测序通量可能看似增加，但有效数据率降低 


    偏倚（Bias）指测序或分子生物学数据中某些序列或区域被过度或不足代表，导致结果不均衡或不客观，影响分析准确性。
        常见偏倚类型包括：
            1. 文库构建偏倚：DNA片段化、接头连接和PCR扩增过程中，某些片段扩增效率不同，导致丰度失真。
            2. 测序偏倚：测序平台对不同碱基或高低GC含量区域敏感，造成测序深度不均。
            3. PCR偏倚：PCR过程中不同序列扩增差异，影响最终文库组成。
            4. 比对偏倚：短序列比对参考基因组时因重复序列或变异导致比对不准确。
        偏倚会影响基因表达、突变检测等分析，导致假阳性或假阴性。
        减少偏倚的方法包括优化文库构建、PCR-free文库、采用高质量测序平台及校正算法。

7️⃣ 文库质量控制（QC）
检查文库的浓度与大小分布：浓度：用 Qubit 或 qPCR 测量。长度分布：用 Bioanalyzer 或 Fragment Analyzer。
    | 项目             | 合格标准（常见参考）                    
    | --------------- | -------------------------------------
    | 文库浓度（qPCR） | ≥ 2 nM（浓缩到可上机浓度，如10–20 pM）    
    | 片段长度分布     | 主要集中在预期范围（±10–20%）            
    | 无明显杂峰       | Bioanalyzer图谱应清晰，无小分子污染       
    | 纯度            | 260/280 = \~1.8；260/230 > 2.0 

🔧 Illumina 测序仪结构总览
    ┌──────────────────────────────┐
    │      Illumina Sequencer      │
    ├────────────┬────────────────┤
    │ 1. 流动槽 Flow Cell          │
    │ 2. 光学系统 Imaging System   │
    │ 3. 化学模块 Reagent Delivery │
    │ 4. 温控系统 Thermal Control  │
    │ 5. 数据处理系统              │
    └────────────┴────────────────┘

🧬 1. Flow Cell（流动槽，也称为芯片）
这是测序仪的核心部件之一，DNA 测序反应就发生在 Flow Cell 内部表面。
通常为一块玻璃或塑料板（一次性使用），内部有多个“lane”（通道），每个 lane 上固定有引物，用于桥式扩增，DNA 分子在表面扩增，形成成千上万的簇（clusters）。
不同型号 flow cell 的 lane 数和密度不同（如 NovaSeq 有 1–4 lanes，NextSeq 有 1 个 lane）。

🧬 Illumina 测序中 Flow Cell 的使用流程：
✅ 1. 加载样本到 Flow Cell（在测序仪中完成）
将文库混合物加载到 Flow Cell 中的通道（lane）上。DNA 片段会与 Flow Cell 表面固定的引物（寡核苷酸）互补配对。
每个lane中会有多个DNA片段结合到固定的引物上

✅ 2. 桥式扩增（Cluster Generation）
在 Flow Cell 内部自动完成（测序仪内置模块）：
单链 DNA 弯曲形成“桥”，与邻近引物结合。DNA 复制产生一簇完全相同的 DNA 分子（cluster）。
循环多轮后一个簇内包含数百到上千条完全相同的 DNA 拷贝。

✅ 3. 测序
测序仪使用反应试剂进行边合成边测序（SBS, Sequencing By Synthesis）。
每一轮加入不同颜色荧光标记的碱基（A/T/G/C），且其3'端被化学修饰，防止继续延伸。
成像记录荧光颜色，反映对应碱基。用化学方法去掉荧光团和3'阻断基团，进行下一轮碱基互补配对。

🧬 一、测序输出中的常见参数含义
| 参数名                       | 含义                                                                   
| ------------------------- | ----------------------------------------------------------------------------------------------- 
| **Run（运行）**            | 一次完整的测序过程称为一个“run”，包括所有cycles、reads、index reads等。                   
| **Read**                  | 指的是对DNA片段进行测序的一次读取。分为 Read 1、Read 2（双端测序）、Index Reads（索引测序）等。        
| **Cycle（循环）**          | 每进行一次碱基的合成和成像，就称为一个cycle；每个read由多个cycles组成。例如150 bp的read有150个cycles。 
| **Index Read**            | 特指对Barcode（Index）序列的读取；通常在主序列之前或中间插入。                                
| **Lane**                  | 一些测序仪（如Illumina HiSeq）将流动槽（flow cell）分为多个“道（lane）”，每个lane可独立运行和上样。   
| **Tile**                  | Flow Cell中lane被进一步分割成多个tile（像素区域），测序数据按tile处理、聚类。                    
| **Cluster**               | Flow Cell上通过桥式扩增形成的DNA簇，每个簇来自一个DNA分子。每个cluster会产生一个read。             
| **Yield / Output**        | 总数据产出量，通常以 Gigabases（Gb）或 Reads 数量表示。                                
| **Q30 / Q-score**         | 测序质量分数，Q30 表示碱基测序正确率≥99.9%；通常Q30越高越好。                                
| **Base Call**             | 每个cycle产生的碱基（A/T/G/C）的判定结果。                                          
| **%PF（Pass Filter）Reads  | 通过质量过滤（过滤掉信号低、重叠等问题的clusters）的reads比例。                               
| **Demultiplexing**        | 多个样本混合测序后，通过Index序列将reads按样本拆分的过程。                                   

| 文件类型                | 说明                               
| ---------------------- | -------------------------------------------------- 
| `FASTQ`                | 最常用的原始测序数据格式，包含序列和质量信息           
| `BCL`                  | Illumina测序仪最初生成的二进制文件，需要转换成FASTQ 
| `RunInfo.xml`          | 描述整个run的基本信息（read结构、cycles等）     
| `SampleSheet.csv`      | 样本信息表，包含样本名、barcode等             
| `InterOp/`             | 运行时统计数据文件（用于BaseSpace或分析工具）      
| `Stats.json` 或 `.xml` | 包含整个测序run的统计结果，如Q30、总数据量等        

######################fastq数据结构####################
@SEQ_ID
GATTTGGGGTTCAAAGCAGTATCGATCAAATAGTAAAGGAGAAGCCTTG
+
!''*((((***+))%%%++)(%%%%).1***-+*''))**55CCF>>>>>

| 行号 | 内容            | 说明                                                      
| -- | ---------------  | ----------------------------------------------------------------------------------------
| 1  | `@SEQ_ID`        | **序列标识符**，以 `@` 开头，后面是 read 的名称（可能包含机器名、lane、read号等）     
| 2  | `GATTTGG...`     | **碱基序列**，A/T/C/G/N 等字母（N 表示不确定的碱基）                       
| 3  | `+` 或 `+SEQ_ID` | 分隔符行（有时带重复的序列标识）                                         
| 4  | `!''*((...`      | 与碱基序列长度相同的字符串，表示 **每个位点的测序质量分数**（Phred score 的 ASCII 编码） 

✅ 示例：
@SRR123456.1 HWI-ST1234:56:D1234ABXX:1:1101:10000:100000 1:N:0:ATCG
ACGTACGTACGTNNNNACGTACGTACGTACGT
+
IIIIIIIIIIII####IIIIIIIIIIIIIIII

➤ 第一部分（读段 ID）：
#   - @SRR123456.1：SRA 中该 read 的唯一编号（@ 表示 read 开始）
#     - SRR123456：SRA Run ID
#     - .1：此样本中的第 1 条 read
#
# ➤ 第二部分（测序仪信息）：
#   - HWI-ST1234：测序仪 ID（如 HiSeq 型号）
#   - 56：测序 Run 编号
#   - D1234ABXX：flowcell（芯片）ID
#   - 1：Lane（通道编号）
#   - 1101：Tile（芯片上的图像区域编号）
#   - 10000：X 坐标
#   - 100000：Y 坐标
#
# ➤ 第三部分（read 对、过滤信息、barcode）：
#   - 1：表示是 Read 1（双端测序中，2 表示 Read 2）
#   - N：是否通过测序过滤（Y = 未通过，N = 通过）
#   - 0：barcode 索引号（通常为 0）
#   - ATCG：index 序列（样本条形码，用于区分混合样本）

---------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------测序后处理-------------------------------------------------------------------
🧬  BAM 
read123  99  chr1  1000  60  76M  =  1076  152  ACGTACGT...  IIIIIII...  NM:i:0  MD:Z:76  AS:i:76
| 字段 | 名称  | 示例值                            | 含义                                
| --- | ----- | -------------------------------- | ----------------------------------------------------------------
| 1   | QNAME | `read123`                        | 原始read名称（来自FASTQ）                 
| 2   | FLAG  | `99`                             | 二进制标志位，表示该read是成对测序的第一条、正向链、比对成功等 
| 3   | RNAME | `chr1`                           | 参考序列的名称（染色体名）                     
| 4   | POS   | `1000`                           | read在参考序列上的起始位置（1-based）          
| 5   | MAPQ  | `60`                             | 比对质量（Mapping Quality），数值越高越可信     
| 6   | CIGAR | `76M`                            | 比对方式：76个碱基匹配（M）                   
| 7   | RNEXT | `=`                              | 配对read比对到的参考序列（同chr1）             
| 8   | PNEXT | `1076`                           | 配对read的位置                         
| 9   | TLEN  | `152`                            | 两条read之间的插入片段长度                   
| 10  | SEQ   | `ACGT...`                        | 原始序列（与FASTQ一致）                    
| 11  | QUAL  | `IIII...`                        | 每个碱基的测序质量（Phred+33）               
| 12+ | TAGs  | `NM:i:0`, `MD:Z:76`, `AS:i:76` 等 | 附加信息：错配数、比对得分等                    
