---------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------测序前处理----------------------------------------------------------------
📚 文库构建的基本流程（Illumina 平台为例）
1️⃣ 样本提取（Sample Extraction）
提取目标 DNA 或 RNA：如果是 RNA，需要先做反转录（Reverse Transcription）转成 cDNA，再转化成双链DNA。
      # Illumina测序只能测DNA的原因：
         1、Illumina测序基于“边合成边测序”（sequencing by synthesis）技术，依赖DNA聚合酶将荧光标记
            的DNA碱基逐步合成并检测。该过程只能扩增和测序DNA分子，RNA分子无法直接被DNA聚合酶识别和扩增。 
         2、RNA分子结构不稳定，易降解，不能直接用于测序。 

2️⃣ 片段化（Fragmentation）
将完整 DNA 切割成片段，长度不一，后续要进行筛选。
方法包括：
      酶切（enzymatic fragmentation）、超声打断（ultrasonication，如 Covaris）、热剪切或机械剪切

3️⃣ 末端修复与加 A 尾（End Repair & A-Tailing）
修复断裂的 DNA 末端，使其变成平端（blunt ends）。给5'链的 3' 末端加一个单个 A（腺嘌呤），为后面接头连接做准备。
--------------------------------------------------------------------------------------------------------
5' ——————————————— 3' 5'链：这一条的起点是5'端，终点是3'端，方向是从左到右
3' ——————————————— 5' 3'链：互补链的方向相反，是从3'端到5'端（右到左）

                                             5' ---NNNNNNNNA---3'    ← A尾，带突出A尾的3'端用于连接带突出T尾的接头
 平末端接头连接到DNA片段的平末端（3’链的5'端）  3' ---NNNNNNNN-----5'   

✅意义：1. 防止接头自连 2. 避免接头错误连接到DNA两端相同的位置
---------------------------------------------------------------------------------------------------------
4️⃣ 接头连接（Adapter Ligation）
将特定的 **双链接头（Adapters）**连接到每个 DNA 片段的两端：
接头内容包括：
    1、测序接头序列：与 flow cell 上的探针互补，便于固定和扩增。
    -----------------------------------------------------------------------------------------------------------------
    2、Barcode（Index）：样本标识码，用于样本混合测序和区分（如 i5/i7 index），对于单索引文库，则一端带i7索引，另一端没有索引。
                        对于双索引文库，则一端带i7索引，另一端带i5索引
    -----------------------------------------------------------------------------------------------------------------
    3、引物结合位点：为测序引物提供结合位置。
    -----------------------------------------------------------------------------------------------------------------
    4、UMI:唯一分子标识，用于识别单个初始DNA或RNA分子#。UMI可以设计在接头的i7端、i5端，或者两端都有，
           具体取决于文库制备方案。 并非所有接头两端都含UMI，有的文库仅单端含UMI，有的则双端都有。
    -----------------------------------------------------------
    [测序接头序列] — [Barcode（Index）] — [引物结合位点]— [UMI]
    -----------------------------------------------------------

    | 特性     | Barcode（Index）         | UMI（唯一分子标识）          
    | -------- | -------------------------| ----------------------------------
    | 目的     | 区分不同样本              | 区分同一样本中不同原始分子        
    | 是否随机 | 否，固定预设计            | 是，随机生成（8-12bp）               
    | 是否唯一 | 样本级别唯一              | 分子级别唯一               
    | 放置位置 | 接头的两端（如i5/i7）     | 接头或引物靠近插入序列的一端       
    | 测序方式 | 用专门的 Index Read 测出  | 通常在 Read 1 的起始几bp中测出 

| 属性          | **i7接头**                    | **i5接头**               
| ----------- | ------------------------------ | ---------------------- 
| **位置**      | P7接头侧（Read 1测序方向）     | P5接头侧（Read 2测序方向）      
| **Index编号** | Index 1（或称 i7 Index）      | Index 2（或称 i5 Index）   
| **测序方式**    | 用 **Index Read 1** 读取    | 用 **Index Read 2** 读取  
| **方向/顺序**   | 正向读取                     | 有些平台/试剂盒需要**反向互补读取**   
| **是否必须**    | 是（单Index时必须）          | 可选（双Index时使用）          
| **引入时机**    | 常在接头或引物中固定设计      | 同上                     
| **样本分辨力**   | 单i7 Index能区分样本        | 双Index（i5+i7）提高准确性和防串扰 


5️⃣ 文库纯化（Purification）
去除残余的接头、短片段或酶等。通常使用磁珠纯化（如 AMPure XP beads）按大小选择片段范围，得到长度符合要求的片段。
                                                                                     小于这个范围的多为接头二聚体或降解片段；
                                                                                     大于这个范围的难以完全扩增或测序不完整。

6️⃣ 可选步骤：文库扩增（Library PCR Amplification）
用 PCR 扩增文库，增加 DNA 量，使其能满足测序需求。需要注意：PCR 循环数不宜过多，否则易引入偏倚。
    文库需要以合适浓度稀释后加载到测序芯片（Flow Cell）上，保证DNA分子均匀、适量地分布，方便桥式扩增形成适量且分散良好的簇（cluster）。
    | 浓度情况     | 可能影响                                                                               
    | ----------- | ----------------------------------------------------------------------------------------------------------------------------------------
    | **浓度过低** | - 上芯片DNA分子数量少，簇数量不足 → 测序通量下降，数据产出低<br>- 测序质量可能下降，信噪比变差                             
    | **浓度过高** | - DNA分子过密，簇间距过近，簇重叠 → 信号混淆，错误率升高<br>- 测序仪难以分辨单个簇，导致数据质量变差<br>- 测序通量可能看似增加，但有效数据率降低 


    偏倚（Bias）指测序或分子生物学数据中某些序列或区域被过度或不足代表，导致结果不均衡或不客观，影响分析准确性。
        常见偏倚类型包括：
            1. 文库构建偏倚：DNA片段化、接头连接和PCR扩增过程中，某些片段扩增效率不同，导致丰度失真。
            2. 测序偏倚：测序平台对不同碱基或高低GC含量区域敏感，造成测序深度不均。
            3. PCR偏倚：PCR过程中不同序列扩增差异，影响最终文库组成。
            4. 比对偏倚：短序列比对参考基因组时因重复序列或变异导致比对不准确。
        偏倚会影响基因表达、突变检测等分析，导致假阳性或假阴性。
        减少偏倚的方法包括优化文库构建、PCR-free文库、采用高质量测序平台及校正算法。

7️⃣ 文库质量控制（QC）
检查文库的浓度与大小分布：浓度：用 Qubit 或 qPCR 测量。长度分布：用 Bioanalyzer 或 Fragment Analyzer。
    | 项目             | 合格标准（常见参考）                    
    | --------------- | -------------------------------------
    | 文库浓度（qPCR） | ≥ 2 nM（浓缩到可上机浓度，如10–20 pM）    
    | 片段长度分布     | 主要集中在预期范围（±10–20%）            
    | 无明显杂峰       | Bioanalyzer图谱应清晰，无小分子污染       
    | 纯度            | 260/280 = \~1.8；260/230 > 2.0 

---------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------测序---------------------------------------------------------------------
🔧 Illumina 测序仪结构总览
    ┌──────────────────────────────┐
    │      Illumina Sequencer      │
    ├────────────┬────────────────┤
    │ 1. 流动槽 Flow Cell          │
    │ 2. 光学系统 Imaging System   │
    │ 3. 化学模块 Reagent Delivery │
    │ 4. 温控系统 Thermal Control  │
    │ 5. 数据处理系统              │
    └────────────┴────────────────┘

🧬 1. Flow Cell（流动槽，也称为芯片）
这是测序仪的核心部件之一，DNA 测序反应就发生在 Flow Cell 内部表面。
通常为一块玻璃或塑料板（一次性使用），内部有多个“lane”（通道），每个 lane 上固定有引物，用于桥式扩增，DNA 分子在表面扩增，形成成千上万的簇（clusters）。
不同型号 flow cell 的 lane 数和密度不同（如 NovaSeq 有 1–4 lanes，NextSeq 有 1 个 lane）。

🧬 Illumina 测序中 Flow Cell 的使用流程：
✅ 1. 将目的DNA片段种到 Flow Cell上
    将文库混合物（模板单链）加载到 Flow Cell 中的通道（lane）上。DNA 片段会与 Flow Cell 表面固定的引物（寡核苷酸）互补配对，一端固定在芯片上（通常是i7端），另一端游离，
此时加入引物1，聚合酶，dntp，进行互补链的合成。完成后加入碱性溶液（NaOH）使DNA解旋，互补链被冲走，留下模板链，完成模板链种植。

✅ 2. 桥式扩增（Cluster Generation）
    加入中性溶液，DNA弯曲，另一端与另一种固定引物结合，DNA两端都固定在芯片上形成桥，加入引物2，聚合酶，dntp，完成复制后加入碱性溶液（NaOH）使DNA解旋，多次重复该流程，便
完成了桥式扩增。

✅ 3. 去除互补链
    切断互补链引物部分，互补链被冲走，只留下模板链进行测序
-------------------------------------------------------------------------------------------------------------------------------
Illumina 等主流二代 DNA 测序平台每次测序，只能得到一条链的序列信息，对于RNA来说，测的模板链是和原始RNA序列具有相同的碱基顺序（T代替U）
而对于DNA来说，由于DNA的两条链是互补的，因此通过一条链的序列，就能推断出另一条，比对软件（如 BWA、STAR）在比对时会自动考虑双链互补信息。
-------------------------------------------------------------------------------------------------------------------------------

✅ 4. 测序
测序仪使用反应试剂进行边合成边测序（SBS, Sequencing By Synthesis）。
加入引物和聚合酶，每一轮加入不同颜色荧光标记的dntp（A/T/G/C），且其3'端被化学修饰（如被叠氮基修饰），无法继续延伸。
合成完后用水冲洗多余的dntp和聚合酶，根据荧光判断接上去的碱基类型，再根据碱基互补配对得到模板链的碱基类型。
完成一轮后，用化学方法去掉荧光团和3'阻断基团，进行下一轮碱基互补配对。重复以上流程完成测序。

🧬 一、测序输出中的常见参数含义
| 参数名                       | 含义                                                                   
| ------------------------- | ----------------------------------------------------------------------------------------------- 
| **Run（运行）**            | 一次完整的测序过程（即一次上机）称为一个“run”，包括所有cycles、reads、index reads等。                   
| **Read**                  | 指的是对DNA片段进行测序的一次读取。分为 Read 1、Read 2（双端测序）、Index Reads（索引测序）等。        
| **Cycle（循环）**          | 每进行一次碱基的合成和成像，就称为一个cycle；每个read由多个cycles组成。例如150 bp的read有150个cycles。 
| **Index Read**            | 特指对Barcode（Index）序列的读取；通常在主序列之前或中间插入。                                
| **Lane**                  | 一些测序仪（如Illumina HiSeq）将流动槽（flow cell）分为多个“道（lane）”，每个lane可独立运行和上样。   
| **Tile**                  | Flow Cell中lane被进一步分割成多个tile（像素区域），测序数据按tile处理、聚类。                    
| **Cluster**               | Flow Cell上通过桥式扩增形成的DNA簇，每个簇来自一个DNA分子。每个cluster会产生一个read。             
| **Yield / Output**        | 总数据产出量，通常以 Gigabases（Gb）或 Reads 数量表示。                                
| **Q30 / Q-score**         | 测序质量分数，Q30 表示碱基测序正确率≥99.9%；通常Q30越高越好。                                
| **Base Call**             | 每个cycle产生的碱基（A/T/G/C）的判定结果。                                          
| **%PF（Pass Filter）Reads  | 通过质量过滤（过滤掉信号低、重叠等问题的clusters）的reads比例。                               
| **Demultiplexing**        | 多个样本混合测序后，通过Index序列将reads按样本拆分的过程。                                   

| 文件类型                | 说明                               
| ---------------------- | -------------------------------------------------- 
| `FASTQ`                | 最常用的原始测序数据格式，包含序列和质量信息           
| `BCL`                  | Illumina测序仪最初生成的二进制文件，需要转换成FASTQ 
| `RunInfo.xml`          | 描述整个run的基本信息（read结构、cycles等）     
| `SampleSheet.csv`      | 样本信息表，包含样本名、barcode等             
| `InterOp/`             | 运行时统计数据文件（用于BaseSpace或分析工具）      
| `Stats.json` 或 `.xml` | 包含整个测序run的统计结果，如Q30、总数据量等        



######################fastq数据结构####################
@SEQ_ID
GATTTGGGGTTCAAAGCAGTATCGATCAAATAGTAAAGGAGAAGCCTTG
+
!''*((((***+))%%%++)(%%%%).1***-+*''))**55CCF>>>>>

| 行号 | 内容            | 说明                                                      
| -- | ---------------  | ----------------------------------------------------------------------------------------
| 1  | `@SEQ_ID`        | **序列标识符**，以 `@` 开头，后面是 read 的名称（可能包含机器名、lane、read号等）     
| 2  | `GATTTGG...`     | **碱基序列**，A/T/C/G/N 等字母（N 表示不确定的碱基）                       
| 3  | `+` 或 `+SEQ_ID` | 分隔符行（有时带重复的序列标识）                                         
| 4  | `!''*((...`      | 与碱基序列长度相同的字符串，表示 **每个位点的测序质量分数**（Phred score 的 ASCII 编码） 

✅ 示例：
@SRR123456.1 HWI-ST1234:56:D1234ABXX:1:1101:10000:100000 1:N:0:ATCG
ACGTACGTACGTNNNNACGTACGTACGTACGT
+
IIIIIIIIIIII####IIIIIIIIIIIIIIII

➤ 第一部分（读段 ID）：
#   - @SRR123456.1：SRA 中该 read 的唯一编号（@ 表示 read 开始）
#     - SRR123456：SRA Run ID
#     - .1：此样本中的第 1 条 read
#
# ➤ 第二部分（测序仪信息）：
#   - HWI-ST1234：测序仪 ID（如 HiSeq 型号）
#   - 56：测序 Run 编号
#   - D1234ABXX：flowcell（芯片）ID
#   - 1：Lane（通道编号）
#   - 1101：Tile（芯片上的图像区域编号）
#   - 10000：X 坐标
#   - 100000：Y 坐标
#
# ➤ 第三部分（read 对、过滤信息、barcode）：
#   - 1：表示是 Read 1（双端测序中，2 表示 Read 2）
#   - N：是否通过测序过滤（Y = 未通过，N = 通过）
#   - 0：barcode 索引号（通常为 0）
#   - ATCG：index 序列（样本条形码，用于区分混合样本）

---------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------索引（用于比对）---------------------------------------------------------------
############################################################################################################
                          #          转录本索引（Transcriptome Index）       #
############################################################################################################
# - 基于已知转录本（mRNA）序列构建的索引
# - 目标：将测序 reads 直接比对到转录本集合
# - 用途：实现高效的基因表达定量
# - 构建所需输入：转录本，通常从注释文件（记录了基因组哪些位置是外显子、内含子）获取
        转录本（transcript） 是指一个基因在转录过程中生成的 RNA 分子，它是基因在表达时的直接产物，通常是指 mRNA（信使 RNA）
        是mRNA 序列的 DNA 形式，序列内容与成熟 mRNA 完全一致（包括剪接结果），没有 intron，通常为拼接后的 exons
        ---------------------------------------------转录本结构-------------------------------------------------
        >ENST00000335137.4 gene:ENSG00000141510.14 gene_biotype:protein_coding transcript_biotype:protein_coding
        ATGGAGGAGCCGCAGTCAGATCCTAGCGTCGCCACCTGGCAGCTGAGGAGCAGGGCGGCGGCAGCTG
        GGCGGAGGCGGAGGCGGGCGGCGGGCGGCAGCGGCGGCGGCGGCGGCGGCGGCGGCGGCGGCGGCAG
        CGGCGGCGGCGGCGGCGGCGGCGGCGGCGGCGGCGGCGGCGGCGGCGGCGGCGGCGGCGGCGGCGGC

        >ENST00000448914.1 gene:ENSG00000237613.2 gene_biotype:protein_coding transcript_biotype:protein_coding
        ATGCCCTTTCGGGGACACCGCCGCGGCCGAGGCGCGGCCGGGAGCTCAGAGCGCGGGGGCGCAGGGC
        CGCGGGCGCAGGCGGGGCCGGCCGCGCGCGCGCGCGCGCGCGCGCGCGCGCGCGCGCGCGCGCGCGC

        > 开头的是转录本的ID和注释信息，例如：
            ENST00000335137.4：转录本编号（Ensembl转录本ID）； #每个mRNA的转录本ID是唯一的
            gene:ENSG00000141510.14：对应基因ID；             #一个基因ID对应多个唯一的转录本ID
            gene_biotype:protein_coding：基因类型；
            transcript_biotype:protein_coding：转录本类型；
            后面紧跟着的是转录本序列
        ----------------------------------------------------------------------------------------------------------
# - 结构：包含转录本序列及转录本与基因的对应关系
# - 常见工具：RSEM、Salmon、Kallisto 等

##########################################################################################################
                        #             基因组索引（Genome Index）          #
##########################################################################################################
# - 基于22对常染色体 + X、Y染色体 + 线粒体DNA序列构建的索引
# - 目标：支持 reads 比对到基因组全区域
# - 用途：适合变异检测、新剪接位点发现等全基因组分析
# - 输入：基因组序列及注释文件（如 GTF/GFF）
# - 结构：包含基因组序列和剪接位点信息
# - 常见工具：STAR、HISAT2、BWA 等

##################################################
#                   总结                         #
##################################################
# 转录本索引：专注于表达量定量，定位于转录本层面
# 基因组索引：用于更全面的基因组范围比对，包含更多基因结构信息
---------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------比对-------------------------------------------------------------------------
🧾 1. 比对后的主文件：
✅ SAM / BAM 文件
文件名示例： sample1.bam 或 sample1.sam
作用： 存储原始的比对结果，每条 read 被比对到参考基因组的位置及其质量等信息

🧬  BAM 
read123  99  chr1  1000  60  76M  =  1076  152  ACGTACGT...  IIIIIII...  NM:i:0  MD:Z:76  AS:i:76
| 字段 | 名称  | 示例值                            | 含义                                
| --- | ----- | -------------------------------- | ----------------------------------------------------------------
| 1   | QNAME | `read123`                        | 原始read名称（来自FASTQ）                 
| 2   | FLAG  | `99`                             | 二进制标志位，表示该read是成对测序的第一条、正向链、比对成功等 
| 3   | RNAME | `chr1`                           | 参考序列的名称（染色体名）                     
| 4   | POS   | `1000`                           | read在参考序列上的起始位置（1-based）          
| 5   | MAPQ  | `60`                             | 比对质量（Mapping Quality），数值越高越可信     
| 6   | CIGAR | `76M`                            | 比对方式：76个碱基匹配（M）                   
| 7   | RNEXT | `=`                              | 配对read比对到的参考序列（同chr1）             
| 8   | PNEXT | `1076`                           | 配对read的位置                         
| 9   | TLEN  | `152`                            | 两条read之间的插入片段长度                   
| 10  | SEQ   | `ACGT...`                        | 原始序列（与FASTQ一致）                    
| 11  | QUAL  | `IIII...`                        | 每个碱基的测序质量（Phred+33）               
| 12+ | TAGs  | `NM:i:0`, `MD:Z:76`, `AS:i:76` 等 | 附加信息：错配数、比对得分等    

BAM 文件本身通常不包含“基因名称”信息，它只记录了每条测序读段（read）与参考基因组（FASTA 序列）之间的比对情况
从 BAM 文件中获取基因名称，需要用到 注释文件（GTF/GFF） 进行进一步解析


---------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------定量（常用于分析表达情况）------------------------------------------------------
🧾 基因本（gene-level） vs 转录本（transcript-level）说明 
# 在 RNA-Seq 分析中，同一个基因可能通过可变剪接（alternative splicing）
# 生成多个不同的转录本（transcripts），这些转录本拥有不同的外显子组合。
-------------------------------------------------------------
# - 基因本（gene-level expression）：
#   表示将所有属于同一个基因的转录本的表达量汇总后的结果。
#   用于分析基因整体的表达水平。
-------------------------------------------------------------
# - 转录本本（transcript-level expression）：
#   表示每一个具体转录本的表达量，保留了可变剪接的信息。
#   适用于研究剪接变异、同义转录本之间的表达差异等。

📌区别转录本------转录本（transcript） 是指一个基因在转录过程中生成的 RNA 分子，它是基因在表达时的直接产物，通常是指 mRNA（信使 RNA）
----------------------------------------------------------------
# 表达定量工具（如 RSEM、Salmon、Kallisto）通常会输出两类结果文件：
#   - *.genes.results       # 基因级表达
#   - *.isoforms.results    # 转录本级表达
#
# 在后续差异表达分析中，可根据研究目的选择基因本或转录本本的结果。
# ---------------------------------------------------------------


📊.genes.results
| gene\_id | transcript\_id(s) | length | effective\_length | expected\_count | TPM  | FPKM |
| -------- | ----------------- | ------ | ----------------- | --------------- | ---- | ---- |
| GeneA    | Tx1,Tx2           | 1000   | 950               | 1345.5          | 42.3 | 36.7 |
| GeneB    | Tx3               | 2000   | 1900              | 204.8           | 10.1 | 8.9  |

| 列名                | 含义                                                                               
| ------------------ | ------------------------------------------------------------------------------------------------ 
| `gene_id`          | 基因的唯一标识（来自 GTF 文件）                                                               
| `transcript_id(s)` | 该基因对应的转录本 ID 列表（逗号分隔）                                                            
| `length`           | 所有转录本拼接后的原始长度（单位：碱基）                                                             
| `effective_length` | 有效长度，考虑序列长度和测序 read 长度的影响后得到的估算值；用于校正表达量                                         
| `expected_count`   | EM算法估计分配给该基因的 read 数量（非整数），可用于差异表达分析（如 DESeq2）                                   
| `TPM`              | Transcripts Per Million，标准化后的表达量，适合比较不同样本间的表达差异                                  
| `FPKM`             | Fragments Per Kilobase of transcript per Million mapped reads，另一种标准化表达方式（常用于旧项目） 
